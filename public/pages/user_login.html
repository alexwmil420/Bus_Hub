<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BusWatch Login</title>
  <link rel="stylesheet" href="../css/main.css" />
</head>
<body class="bg-background min-h-screen flex items-center justify-center">

  <!-- Login Form Card -->
  <div class="bg-surface rounded-lg shadow-lg p-8 w-full max-w-md">
    <h1 class="text-2xl font-bold mb-4 text-center">BusWatch Login</h1>

    <!-- Error Box -->
    <div id="loginError" class="hidden bg-red-100 text-red-700 p-2 rounded mb-4">
      <span id="loginErrorMessage"></span>
    </div>

    <form id="loginForm" class="space-y-4">
      <div>
        <label for="email" class="block mb-1 font-medium">Email</label>
        <input type="email" id="email" name="email" required class="form-input w-full p-2 border rounded" placeholder="user@ub.edu.bz" />
      </div>
      <div>
        <label for="password" class="block mb-1 font-medium">Password</label>
        <input type="password" id="password" name="password" required class="form-input w-full p-2 border rounded" placeholder="Enter password" />
      </div>
      <button type="submit" id="loginButton" class="w-full bg-primary text-white p-2 rounded font-semibold flex justify-center items-center">
        <span id="loginButtonText">Sign In</span>
        <svg id="loginSpinner" class="w-5 h-5 ml-2 animate-spin hidden" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
        </svg>
      </button>
    </form>
  </div>

  <!-- Firebase + Login Script -->
  <script type="module">
    import { auth, signInWithEmailAndPassword, db, doc, getDoc } from "./firebase/firebase.js";

    // UB email check
    function validateUBDomain(email) {
      return email.toLowerCase().endsWith("@ub.edu.bz");
    }

    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      const loginError = document.getElementById("loginError");
      const loginErrorMessage = document.getElementById("loginErrorMessage");

      loginError.classList.add("hidden");

      if (!validateUBDomain(email)) {
        loginErrorMessage.textContent = "Only UB (@ub.edu.bz) emails are allowed.";
        loginError.classList.remove("hidden");
        return;
      }

      // Show spinner
      document.getElementById("loginButtonText").textContent = "Signing In...";
      document.getElementById("loginSpinner").classList.remove("hidden");

      try {
        // Firebase login
        const userCred = await signInWithEmailAndPassword(auth, email, password);
        const uid = userCred.user.uid;

        // Get role from Firestore
        const userRef = doc(db, "users", uid);
        const userSnap = await getDoc(userRef);

        if (!userSnap.exists()) {
          loginErrorMessage.textContent = "User record missing. Contact admin.";
          loginError.classList.remove("hidden");
          return;
        }

        const role = userSnap.data().role;

        // Redirect based on role
        if (role === "admin") window.location.href = "admin_dashboard.html";
        else if (role === "driver") window.location.href = "driver_dashboard.html";
        else window.location.href = "user_dashboard.html";

      } catch (err) {
        loginErrorMessage.textContent = "Invalid email or password.";
        loginError.classList.remove("hidden");
        console.error(err);
      }

      // Reset button
      document.getElementById("loginButtonText").textContent = "Sign In";
      document.getElementById("loginSpinner").classList.add("hidden");
    });

    // Autofocus
    window.addEventListener("load", () => {
      document.getElementById("email").focus();
    });
  </script>

</body>
</html>
